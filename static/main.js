function initApp(){window!=window.top&&$("#back_to_patient").hide(),Patient.findOne({id:"x"}).then(function(t){var n=TrialFinder();n.attr("patient",t),$("#app").html(can.view("app_tmpl",{finder:n})),n.find(t)})}function sortedKeysFromDict(t){var n=[];for(var r in t)n[n.length]=r;return n.sort(),n}function sortChildren(t,n,r){var e=t.children(n).get();e.sort(r),$.each(e,function(n,r){t.append(r)})}function newUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=16*Math.random()|0,r="x"==t?n:3&n|8;return r.toString(16)})}Array.prototype.contains=function(t){return this.indexOf(t)>=0},"indexOf"in Array.prototype||(Array.prototype.indexOf=function(t){for(var n=0;n<this.length;n++)if(this[n]==t)return n;return-1}),Array.prototype.uniqueArray=function(){for(var t={},n=[],r=0,e=this.length;e>r;++r)t.hasOwnProperty(this[r])||(n.push(this[r]),t[this[r]]=1);return n},window.console||!function(){var t=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"],n=t.length;window.console={};for(var r=0;n>r;r++)window.console[t[r]]=function(){}}();var Patient=can.Model.extend({id:"_id",findOne:"GET /patients/{id}",update:"PUT /patients/{_id}"},{}),TrialFinder=can.Model.extend({},{status:null,error:null,patient:null,result:null,find:function(t,n,r){var e=this;e.attr("status","Searching..."),e.attr("error",null),e.attr("result",null),$.getJSON("/find").always(function(t,n,r){"success"==n?(e.attr("status","Sorting..."),t&&(e.attr("result",new TrialFinderResult(t)),e.attr("complete",!0))):e.attr("error","Error: "+r.toString()),e.attr("status",null)})}}),_intervention_map={Biological:"Drug/Biological",Drug:"Drug/Biological",Behavioral:"Behavioral/Other",Other:"Behavioral/Other"},TrialFinderResult=can.Model.extend({},{results:null,numShown:0,interventions:null,phases:null,showPhases:!1,init:function(t){return t?(this.attr("results",TrialResult.fromJSON(t.results)),this.collectInterventions(),void this.collectPhases()):null},updateTrialShownState:function(){for(var t=$.map(this.interventions,function(t,n){return t.active?t.name:null}),n=$.map(this.phases,function(t,n){return t.active?t.name:null}),r={},e=0;e<this.results.length;e++){var i=this.results[e];i.attr("shownForInterventions",!1),i.attr("shownForPhases",!1);var a=i.trial;if(a&&a.interventions)for(var s=0;s<a.interventions.length;s++){var o=a.interventions[s];o=o in _intervention_map?_intervention_map[o]:o,t.indexOf(o)>=0&&i.attr("shownForInterventions",!0)}if(a&&a.phases)for(var s=0;s<a.phases.length;s++){var l=a.phases[s];if(i.attr("shownForPhases",i.shownForPhases||n.indexOf(l)>=0),i.shownForInterventions){var h=r[l]||0;r[l]=h+1}}}for(var u=0,e=0;e<this.results.length;e++)this.results[e].attr("shown")&&u++;this.attr("numShown",u);for(var e=0;e<this.phases.length;e++){var l=this.phases[e];l.attr("num_matches",r[l.name]||0)}this.attr("showPhases",t.length>0)},collectInterventions:function(){if(!(this.interventions&&this.interventions.length>0)){for(var t=[],n={},r=0;r<this.results.length;r++){var e=this.results[r].trial;if(e&&e.interventions)for(var i=0;i<e.interventions.length;i++){var a=e.interventions[i];a in _intervention_map&&(a=_intervention_map[a]);var s=n[a];if(s)s.addMatch();else{var o=new TrialIntervention(null,a);o.parent=this,o.addMatch(),n[a]=o,t.push(o)}}}t.length>0&&this.attr("interventions",t.sort(TrialGroupable.sortByName))}},collectPhases:function(){if(!(this.phases&&this.phases.length>0)){for(var t=[],n={},r=0;r<this.results.length;r++){var e=this.results[r].trial;if(e&&e.phases)for(var i=0;i<e.phases.length;i++){var a=e.phases[i],s=n[a];if(!s){var o=new TrialPhase(null,a);o.parent=this,n[a]=o,t.push(o)}}}this.attr("phases",t.sort(TrialGroupable.sortByName))}}}),TrialGroupable=can.Model.extend({sortByName:function(t,n){return t.name>n.name?1:t.name<n.name?-1:0}},{parent:null,name:null,huid:null,active:!1,num_matches:0,addMatch:function(){this.attr("num_matches",this.num_matches+1)}}),TrialIntervention=TrialGroupable.extend({},{init:function(t,n){this.attr("name",n),this.attr("huid","intervention_"+this.name.replace(/\W\D/,"_"))}}),TrialPhase=TrialGroupable.extend({},{init:function(t,n){this.attr("name",n),this.attr("huid","phase_"+this.name.replace(/\W\D/,"_")),this.attr("active",!0)}}),TrialResult=can.Model.extend({fromJSON:function(t){if(!t)return null;for(var n=[],r=0;r<t.length;r++){var e=new TrialResult(t[r]);n.push(e)}return n}},{reason:null,shown:!1,shownForInterventions:!1,shownForPhases:!1,init:function(t){this.attr("trial",new Trial(t.trial)),this.bind("shownForInterventions",function(t,n,r){this.attr("shown",n&&this.shownForPhases)}),this.bind("shownForPhases",function(t,n,r){this.attr("shown",n&&this.shownForInterventions)})}}),Trial=can.Model.extend({findAll:"GET /trials",geocode:function(t,n){for(var r=0;r<t.length;r++)t[r].geocode(n)},fromJSON:function(t){if(!t)return null;for(var n=[],r=0;r<t.length;r++)n.push(new Trial(t[r]));return n}},{interventions:null,phases:null,init:function(t){this.attr("phasesFormatted",$.makeArray(this.phases).sort().join(", ")),this.attr("keywordsFormatted",$.makeArray(this.keyword).sort().join(", "))}});