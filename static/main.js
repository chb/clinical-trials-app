function initApp(){window!=window.top&&$("#back_to_patient").hide(),Patient.findOne({id:"x"}).then(function(t){var i=TrialFinder();i.attr("patient",t),$("#app").html(can.view("app_tmpl",{finder:i})),i.find(t)})}function sortedKeysFromDict(t){var i=[];for(var n in t)i[i.length]=n;return i.sort(),i}function sortChildren(t,i,n){var e=t.children(i).get();e.sort(n),$.each(e,function(i,n){t.append(n)})}function newUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=16*Math.random()|0,n="x"==t?i:3&i|8;return n.toString(16)})}jQuery.extend({putJSON:function(t,i){return $.ajax({type:"PUT",url:t,contentType:"application/json",data:JSON.stringify(i),dataType:"json"})}}),Array.prototype.contains=function(t){return this.indexOf(t)>=0},"indexOf"in Array.prototype||(Array.prototype.indexOf=function(t){for(var i=0;i<this.length;i++)if(this[i]==t)return i;return-1}),Array.prototype.uniqueArray=function(){for(var t={},i=[],n=0,e=this.length;e>n;++n)t.hasOwnProperty(this[n])||(i.push(this[n]),t[this[n]]=1);return i},window.console||!function(){var t=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"],i=t.length;window.console={};for(var n=0;i>n;n++)window.console[t[n]]=function(){}}();var Patient=can.Model.extend({id:"_id",findOne:"GET /patients/{id}",update:"PUT /patients/{_id}"},{init:function(t){this.attr("hasConditions",this.conditions&&this.conditions.length>0)}}),TrialFinder=can.Model.extend({},{patient:null,result:null,find:function(t,i,n){var e=this;e.attr("status","Searching..."),e.attr("error",null),e.attr("result",null),$.getJSON("/find",{condition:"Breast Cancer"}).always(function(t,i,n){if("success"==i){if(e.attr("status","Sorting..."),t){var s=new TrialFinderResult(t);e.attr("result",s),e.attr("complete",!0)}}else e.attr("error","Error: "+n.toString());e.attr("status",null)})}}),_intervention_map={Biological:"Drug/Biological",Drug:"Drug/Biological",Behavioral:"Behavioral/Other",Other:"Behavioral/Other"},TrialFinderResult=can.Model.extend({},{patient_id:null,results:null,showSuggested:!0,numSuggested:"~",showEligible:!0,numEligible:"~",showIneligible:!1,numIneligible:"~",numShown:0,numShownTitle:null,interventions:null,phases:null,init:function(t){return t?(this.attr("results",TrialResult.fromJSON(t.results,this)),this.countResults(),this.collectInterventions(),this.collectPhases(),void this.updateTrialShownState()):null},countResults:function(){for(var t=0,i=0,n=0,e=0;e<this.results.length;e++)"ineligible"==this.results[e].overallStatus()?n++:i++;this.attr("numSuggested",t),this.attr("numEligible",i),this.attr("numIneligible",n)},collectInterventions:function(){if(!(this.interventions&&this.interventions.length>0)){for(var t=[],i={},n=0;n<this.results.length;n++){var e=this.results[n].trial;if(e&&e.interventions)for(var s=[],r=0;r<e.interventions.length;r++){var a=e.interventions[r];if(a in _intervention_map&&(a=_intervention_map[a]),!s.contains(a)){s.push(a);var o=i[a];o||(o=new TrialIntervention(null,a),o.parent=this,i[a]=o,t.push(o))}}}t.length>0&&this.attr("interventions",t.sort(TrialGroupable.sortByName))}},collectPhases:function(){if(!(this.phases&&this.phases.length>0)){for(var t=[],i={},n=0;n<this.results.length;n++){var e=this.results[n].trial;if(e&&e.phases)for(var s=0;s<e.phases.length;s++){var r=e.phases[s],a=i[r];a||(a=new TrialPhase(null,r),a.parent=this,i[r]=a,t.push(a))}}this.attr("phases",t.sort(TrialGroupable.sortByName))}},toggleShowSuggested:function(){this.attr("showSuggested",!this.showSuggested),this.updateTrialShownState()},toggleShowEligible:function(){this.attr("showEligible",!this.showEligible),this.updateTrialShownState()},toggleShowIneligible:function(){this.attr("showIneligible",!this.showIneligible),this.updateTrialShownState()},updateTrialShownState:function(){for(var t=$.map(this.interventions,function(t,i){return t.active?t.name:null}),i=$.map(this.phases,function(t,i){return t.active?t.name:null}),n={},e={},s=!1,r=0,a=0;a<this.results.length;a++){var o=this.results[a];o.attr("shownForInterventions",!1),o.attr("shownForPhases",!1);var l=o.trial;if(l&&l.status?"suggested"==l.status?o.attr("shownForStatus",this.showSuggested):"eligible"==l.status?o.attr("shownForStatus",this.showEligible):"ineligible"==l.status?o.attr("shownForStatus",this.showIneligible):(console.warn("Trial has an unknown status:",l.status),o.attr("shownForStatus",!0)):console.error("No trial status, or worse: no trial",l,l?l.status:void 0),l&&l.interventions)for(var h=0;h<l.interventions.length;h++){var u=l.interventions[h];if(u=u in _intervention_map?_intervention_map[u]:u,o.attr("shownForInterventions",o.shownForInterventions||t.indexOf(u)>=0),o.shownForStatus){var d=n[u]||0;n[u]=d+1}}if(l&&l.phases)for(var h=0;h<l.phases.length;h++){var f=l.phases[h];if(o.attr("shownForPhases",o.shownForPhases||i.indexOf(f)>=0),o.shownForStatus&&o.shownForInterventions){var d=e[f]||0;e[f]=d+1,s=!0}}o.shown&&r++}this.attr("numShown",r),r>1?this.attr("numShownTitle",r+" Trials"):this.attr("numShownTitle",r>0?"1 Trial":null);for(var a=0;a<this.interventions.length;a++){var c=this.interventions[a];c.attr("numMatches",n[c.name]||0)}for(var a=0;a<this.phases.length;a++){var f=this.phases[a];f.attr("numMatches",e[f.name]||0)}this.attr("showPhases",s)}}),TrialGroupable=can.Model.extend({sortByName:function(t,i){return t.name>i.name?1:t.name<i.name?-1:0}},{parent:null,name:null,huid:null,active:!1,numMatches:0,addMatch:function(){this.attr("numMatches",this.numMatches+1)}}),TrialIntervention=TrialGroupable.extend({},{init:function(t,i){this.attr("name",i),this.attr("huid","intervention_"+this.name.replace(/\W\D/,"_"))}}),TrialPhase=TrialGroupable.extend({},{init:function(t,i){this.attr("name",i),this.attr("huid","phase_"+this.name.replace(/\W\D/,"_")),this.attr("active",!0)}}),TrialResult=can.Model.extend({fromJSON:function(t,i){if(!t)return null;for(var n=[],e=0;e<t.length;e++){var s=new TrialResult(t[e]);s.finder=i,n.push(s)}return n}},{finder:null,init:function(t){this.attr("tests",new TrialResultTest.fromJSON(t.tests)),this.attr("hasTests",this.tests&&this.tests.length>0),this.attr("canEdit",!0),this.attr("suggested",this.patient_info&&this.patient_info.suggested);var i=new Trial(t.trial);i.attr("status",this.overallStatus()),this.attr("trial",i),this.bind("shownForStatus",function(t,i,n){this.attr("shown",i&&this.shownForInterventions&&this.shownForPhases)}),this.bind("shownForInterventions",function(t,i,n){this.attr("shown",i&&this.shownForStatus&&this.shownForPhases)}),this.bind("shownForPhases",function(t,i,n){this.attr("shown",i&&this.shownForStatus&&this.shownForInterventions)})},setCanEdit:function(t){this.attr("canEdit",t)},edit:function(){TrialEditor.singleton().edit(this)},cancel:function(){TrialEditor.singleton().done(this)},save:function(){TrialEditor.singleton().save(this)},suggest:function(){this.attr("suggested",!this.suggested)},updateFromPatientInfo:function(t){t&&t.trial_id==this.trial._id&&t.patient_id==this.finder.patient_id?this.attr("patient_info",t):console.error("Cannot update from patient info because of trial_id/patient_id mismatch:",t.trial_id,this.trial._id,t.patient_id,this.finder.patient_id)},overallStatus:function(){if(this.tests)for(var t=0;t<this.tests.length;t++)if("fail"==this.tests[t].status)return"ineligible";return"eligible"}}),TrialResultTest=can.Model.extend({fromJSON:function(t){if(!t)return null;for(var i=[],n=0;n<t.length;n++)i.push(new TrialResultTest(t[n]));return i}},{}),Trial=can.Model.extend({findAll:"GET /trials",geocode:function(t,i){for(var n=0;n<t.length;n++)t[n].geocode(i)},fromJSON:function(t){if(!t)return null;for(var i=[],n=0;n<t.length;n++)i.push(new Trial(t[n]));return i}},{interventions:null,phases:null,init:function(t){if(this.updateFromInfo(),this.phases&&this.attr("phasesFormatted",$.makeArray(this.phases).sort().join(", ")),this.attr("primary_outcome"))for(var i=0;i<this.attr("primary_outcome").length;i++){var n=this.attr("primary_outcome")[i];"safety_issue"in n&&n.attr("safety_issue","Yes"==n.safety_issue)}if(this.attr("secondary_outcome"))for(var i=0;i<this.attr("secondary_outcome").length;i++){var n=this.attr("secondary_outcome")[i];"safety_issue"in n&&n.attr("safety_issue","Yes"==n.safety_issue)}},updateFromInfo:function(t){t&&this.attr("info",t),this.attr("mainTitle",this.info&&this.info.title?this.info.title:this.title)},previewTitle:function(t,i,n){var e=$("#edit_title");e.val()==this.title?e.val(this.attr("previousTitle")):(this.attr("previousTitle",e.val()),e.val(this.title))}}),TrialEditor=can.Construct.extend({singleton:function(){return null===this._instance&&(this._instance=new TrialEditor),this._instance},_instance:null},{result:null,edit:function(t){this.done(this.result),this.result=t,this.result.attr("editing",!0)},done:function(t){null!==this.result&&t===this.result&&(this.result.attr("editing",!1),this.result=null)},save:function(t){if(!this.result||t!==this.result||!this.result.attr("editing"))return void alert("Not currently editing this trial");var i=this.result;i.setCanEdit(!1);var n={title:$("#edit_title").val(),notes:$("#edit_notes").val()},e={notes:$("#edit_patient_notes").val()},s=i.trial;$.putJSON("trials/"+s._id+"/info",n).done(function(t,n,r){s.updateFromInfo(t?t.trial:null),i.finder&&i.finder.patient_id?$.putJSON("trials/"+s._id+"/patient/"+i.finder.patient_id+"/info",e).done(function(t,n,e){i.updateFromPatientInfo(t),i.setCanEdit(!0)}).fail(function(t,n,e){console.error("Failed to save trial patient info:",n,e),alert("Failed to save trial patient info: "+e),i.setCanEdit(!0)}):(console.error("Failed to save patient specific trial info because there is no patient id"),i.setCanEdit(!0))}).fail(function(t,n,e){console.error("Failed to save trial info:",n,e),alert("Failed to save trial info: "+e),i.setCanEdit(!0)}),this.done(i)}});